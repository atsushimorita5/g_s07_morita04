<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- <link rel ="stylesheet" href="css/reset.css"> -->
    <!-- <link rel ="stylesheet" href="css/style.css"> -->
    <title>canvas_base.html</title>
  </head>
  <body>
    <section>
      <h1>アツモリ塗り絵</h1>
      <nav>
        <!-- 線の色を変更するHTML要素 -->
        <input type="color" id="color" value="">
        <!-- 線の太さを変更するHTML要素 -->
        <input type="range" id="range" value="20" min="1" max="100" >
        <button id="clear_btn">クリアー</button>
      </nav>
      <canvas id="drawarea" width="500" height="500" style="border:1px solid blue;"></canvas>
      
      <p><button id="save_btn">保存する</button></p>
      <a id="download" href="#" download="canvas.jpg">画像をダウンロードする</a>
    </section>
    <script src="js/jquery-2.1.3.min.js"></script>
    </script>  
    <script>
      const canvas = document.getElementById("drawarea");
      const ctx = canvas.getContext("2d");
      // 画像を入れたい　　　　
      const rengoku = new Image();      
      rengoku.src ="rengoku.png";     
      rengoku.onload = function() {           
      ctx.drawImage(rengoku, 0, 0,canvas.width,canvas.height);     
      };
      let canvas_mouse_event = false;
      let oldX = 0; // 1つ前のX座標
      let oldY = 0; // 1つ前のY座標
      let bold_line = 3; // 線の太さ
      let color = "#ff0000";　// 線の色
      
      // ここからマウスダウンの処理
      $(canvas).on("mousedown", function(e) {
        console.log(e.offsetX);
        console.log(e.offsetY);
        // canvas上でマウスを動かした時に、線を描けるようにしてくれ
        canvas_mouse_event = true;
        // 描き始める位置をoldX,oldYにいれる
        oldX = e.offsetX;
        oldY = e.offsetY;
      });
      
      // ここからマウスムーブの処理
      $(canvas).on("mousemove", function(e){
        if(canvas_mouse_event === true) {
          // マウスを動かした先のx座標の値を取ってくる
          const px = e.offsetX;
          // マウスを動かした先のy座標の値を取ってくる
          const py = e.offsetY;
          // マウスを動かした先のZ座標の値を取ってくる
          // 線の色
          ctx.strokeStyle = color;
          // 線の太さ
          ctx.lineWidth = bold_line;
          // 線の形状を決める
          ctx.lineCap = "round";
          // 線の形状を決める（線の角で面取りするか）
          ctx.lineJoin = "round";
          // 描画を開始
          ctx.beginPath();
          // カーソルを移動する
          ctx.moveTo(oldX, oldY);
          // 線を移動しながら書く
          ctx.lineTo(px, py);
          // 線を描画する
          ctx.stroke();
          
          oldX = px;
          oldY = py;
        }
      });
      
      // マウスを離した時の動作
      $(canvas).on("mouseup",function() {
        canvas_mouse_event = false;
      });
      
      // クリアボタンを押した時の動作
      $("#clear_btn").on("click", function() {
        ctx.beginPath();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
      
      $(canvas).on("mouseout", function() {
        canvas_mouse_event = false;
      });
      
      $("#range").on("change", function() {
        bold_line = $("#range").val();
      });
      
      $("#color").on("change", function() {
        color = $("#color").val();
      });
      // 保存ボタンを押した時の動作を考える
      $("#save_btn").on("click", function() {
        alert("画像を保存しました");
        console.log(save_data);
      });
      //画像をダウンロードする
      $("#download").click(function(){
        drawarea = document.getElementById("drawarea");
        var base64 = canvas.toDataURL("image/png");
        console.log(base64);
        document.getElementById("download").href = base64;
      });
    </script>
  </body>
</html>